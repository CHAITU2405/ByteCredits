<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pod Analytics - Teacher Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .analytics-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .analytics-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .analytics-card:hover {
            transform: translateY(-2px);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .pod-row {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        .pod-row:hover {
            transform: translateY(-2px);
        }
        .progress-ring {
            width: 60px;
            height: 60px;
        }
        .progress-ring circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .leader-badge {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.8rem;
        }
        .collaboration-score {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.8rem;
        }
        .insight-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-bar"></i> Pod Analytics
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('learning_pods_dashboard') }}">
                    <i class="fas fa-arrow-left"></i> Back to Pods
                </a>
                <a class="nav-link" href="{{ url_for('teacher_dashboard') }}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Analytics Header -->
        <div class="analytics-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 mb-2">
                        <i class="fas fa-chart-bar"></i> Learning Pods Analytics
                    </h1>
                    <p class="mb-0">
                        Real-time insights into pod dynamics, collaboration patterns, and learning outcomes
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" onclick="refreshAnalytics()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <h3>{{ analytics|length }}</h3>
                    <p class="mb-0">Active Pods</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h3>{{ analytics|sum(attribute='member_count') }}</h3>
                    <p class="mb-0">Total Students</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h3>{{ "%.1f"|format((analytics|sum(attribute='task_completion_rate') / analytics|length) if analytics|length > 0 else 0) }}%</h3>
                    <p class="mb-0">Avg Completion Rate</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h3>{{ analytics|sum(attribute='collaboration_events') }}</h3>
                    <p class="mb-0">Collaboration Events</p>
                </div>
            </div>
        </div>

        <!-- AI Insights Panel -->
        <div class="insight-panel">
            <h4><i class="fas fa-robot"></i> AI-Generated Insights</h4>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-lightbulb"></i> Top Performers:</h6>
                    <p class="mb-2">
                        {% set top_pods = analytics|sort(attribute='task_completion_rate', reverse=true)|list %}
                        {% if top_pods %}
                        <strong>{{ top_pods[0].pod.pod_name }}</strong> leads with {{ "%.1f"|format(top_pods[0].task_completion_rate) }}% completion rate.
                        {% else %}
                        No performance data available yet.
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-exclamation-triangle"></i> Attention Needed:</h6>
                    <p class="mb-2">
                        {% set low_pods = analytics|selectattr('task_completion_rate', '<', 50)|list %}
                        {% if low_pods %}
                        {{ low_pods|length }} pod(s) below 50% completion rate need support.
                        {% else %}
                        All pods are performing well!
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Pod Performance Table -->
        <div class="chart-container">
            <h4><i class="fas fa-table"></i> Pod Performance Overview</h4>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Pod Name</th>
                            <th>Subject</th>
                            <th>Members</th>
                            <th>Leader</th>
                            <th>Completion Rate</th>
                            <th>Collaboration Score</th>
                            <th>Badges Earned</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pod_data in analytics %}
                        <tr class="pod-row">
                            <td>
                                <strong>{{ pod_data.pod.pod_name }}</strong><br>
                                <small class="text-muted">Cycle {{ pod_data.pod.cycle_number }}</small>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ pod_data.pod.subject }}</span>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ pod_data.member_count }} students</span>
                                <br>
                                <small class="text-muted">
                                    {% for member in pod_data.members[:3] %}
                                        {{ member }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                    {% if pod_data.members|length > 3 %}
                                        +{{ pod_data.members|length - 3 }} more
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                {% if pod_data.leader %}
                                <span class="leader-badge">{{ pod_data.leader }}</span>
                                {% else %}
                                <span class="text-muted">No leader assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress-ring me-2">
                                        <svg class="progress-ring" width="40" height="40">
                                            <circle class="progress-ring-circle" stroke="#e6e6e6" stroke-width="3" 
                                                    fill="transparent" r="17" cx="20" cy="20"/>
                                            <circle class="progress-ring-circle" stroke="#4facfe" stroke-width="3" 
                                                    fill="transparent" r="17" cx="20" cy="20" 
                                                    stroke-dasharray="106.81" 
                                                    stroke-dashoffset="{{ 106.81 - (pod_data.task_completion_rate / 100 * 106.81) }}"/>
                                        </svg>
                                    </div>
                                    <span class="fw-bold">{{ "%.1f"|format(pod_data.task_completion_rate) }}%</span>
                                </div>
                            </td>
                            <td>
                                <span class="collaboration-score">
                                    {{ pod_data.collaboration_events }} events
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-success">{{ pod_data.badges_earned }} badges</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('pod_detail', pod_id=pod_data.pod.id) }}" 
                                       class="btn btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-outline-success" 
                                            onclick="generateTasks({{ pod_data.pod.id }})">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" 
                                            onclick="rotatePod({{ pod_data.pod.id }})">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Collaboration Patterns Chart -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h4><i class="fas fa-chart-pie"></i> Task Completion Distribution</h4>
                    <canvas id="completionChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h4><i class="fas fa-chart-bar"></i> Collaboration Activity</h4>
                    <canvas id="collaborationChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Insights -->
        <div class="chart-container">
            <h4><i class="fas fa-microscope"></i> Detailed Insights</h4>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-users"></i> Natural Leaders Identified:</h6>
                    <ul class="list-group list-group-flush">
                        {% for pod_data in analytics %}
                        {% if pod_data.leader %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ pod_data.leader }}</strong><br>
                                <small class="text-muted">{{ pod_data.pod.pod_name }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">
                                {{ "%.1f"|format(pod_data.task_completion_rate) }}%
                            </span>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-heart"></i> Students Needing Support:</h6>
                    <ul class="list-group list-group-flush">
                        {% for pod_data in analytics %}
                        {% if pod_data.task_completion_rate < 50 %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ pod_data.pod.pod_name }}</strong><br>
                                <small class="text-muted">{{ pod_data.member_count }} members</small>
                            </div>
                            <span class="badge bg-warning rounded-pill">
                                {{ "%.1f"|format(pod_data.task_completion_rate) }}%
                            </span>
                        </li>
                        {% endif %}
                        {% endfor %}
                        {% if analytics|selectattr('task_completion_rate', '<', 50)|list|length == 0 %}
                        <li class="list-group-item text-success">
                            <i class="fas fa-check-circle"></i> All pods are performing well!
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Completion Chart
        const completionCtx = document.getElementById('completionChart').getContext('2d');
        const completionChart = new Chart(completionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'In Progress', 'Not Started'],
                datasets: [{
                    data: [
                        {{ analytics|sum(attribute='task_completion_rate') / analytics|length if analytics|length > 0 else 0 }},
                        {{ 100 - (analytics|sum(attribute='task_completion_rate') / analytics|length if analytics|length > 0 else 0) }},
                        0
                    ],
                    backgroundColor: ['#4facfe', '#43e97b', '#fa709a']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Collaboration Chart
        const collaborationCtx = document.getElementById('collaborationChart').getContext('2d');
        const collaborationChart = new Chart(collaborationCtx, {
            type: 'bar',
            data: {
                labels: {{ analytics|map(attribute='pod.pod_name')|list|tojson }},
                datasets: [{
                    label: 'Collaboration Events',
                    data: {{ analytics|map(attribute='collaboration_events')|list|tojson }},
                    backgroundColor: 'rgba(79, 172, 254, 0.8)',
                    borderColor: 'rgba(79, 172, 254, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        function refreshAnalytics() {
            location.reload();
        }

        function generateTasks(podId) {
            if (!confirm('Generate new tasks for this pod?')) return;
            
            fetch(`/generate_pod_tasks/${podId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully generated ${data.tasks.length} tasks!`);
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to generate tasks'));
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }

        function rotatePod(podId) {
            if (confirm('Are you sure you want to rotate this pod? This will reshuffle the members.')) {
                alert('Pod rotation feature coming soon!');
            }
        }
    </script>
</body>
</html>
